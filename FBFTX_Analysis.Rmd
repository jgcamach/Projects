---
title: "R Notebook"
output: html_notebook
---

The historical prices of the FBFTX fund can be found at [Nasdaq](www.nasdaq.com/market-activity/mutual-fund/fbftx/historical)

```{r Configuring Data, message=FALSE, warning=FALSE}
########################################################################
# FBFTX Mutual Fund Time Series Analysis - Data Collection and Organization
# 
# Purpose: This script loads historical price data for the FBFTX mutual fund
#          and transforms it into an analysis-ready format with calculated
#          returns (percent change and log first differences) grouped by time periods.
#########################################################################
library(xts)
library(tidyverse)
library(Hmisc)
library(lubridate)
library(paletteer)
library(palettetown)
library(ggplot2)
library(forecast)
library(ggridges)

#**Replace file pathway with path on your own computer.**
FBFTX <- read.csv("C:\\R_Files\\Financial Model\\FBFTX_Historic_Price.csv")


delchange <- function(n) {
  return(n/c(n[1],n[-length(n)]))
}


transform <- function(a) {
  percentchange = delchange(a$Close.Last)[-1]
  delln = diff(log(a$Close.Last))
  a = a[-1,]
  a = mutate(
      a, 
      Date = (as.Date(a$Date, '%m/%d/%Y')), 
      "Percent Change" = percentchange-1, 
      "Log First Difference" = delln, 
      Volume = NULL, 
      High = NULL, 
      Low = NULL, 
      Open = NULL,
      "Closing Price" = Close.Last,
      "Adjusted.Close" = NULL,
      .keep = "unused")
  return(a)
}

timeseries = function(x) {
  x = group_by(x, 
               month = month(Date), 
               year = year(Date), 
               day = wday(Date, label = TRUE))
  return(x)
}

facetable <- function(x) {
    datlong <- gather(x, 
                      key = "variable",
                      value = "value", 
                      -Date)
    return(datlong)
}

FBFTX <- FBFTX %>%
  transform() %>% 
  timeseries()

datlong <- facetable(FBFTX)
```

```{r Visualizing Data, message=FALSE}

p0 <- datlong %>%
  ggplot(
    aes(Date, value, color = variable)
  )+
  geom_line(
    linewidth = 0.5
  )+
  scale_color_manual(
    values = c("coral","#bf7fff","steelblue")
  )+
  facet_grid(
    vars(variable),
    scales = "free_y", 
    labeller = label_value
  )+
  labs(
    x = "Date"
  )+
  guides(
    color = "none"
)
  
p1 <-  FBFTX %>%
  ggplot(
    aes(Date,`Percent Change`, color = factor(month))
  )+
  geom_point(
  )+
  scale_color_poke(
    pokemon = 144
  )+
  theme_dark(
  )+
  labs(
    title = "Daily Price Change Colored by Month",
    color = "Month",
    x = "Date",
    y = "Percent Change"
)
    
#Plotting Percent change by day of the week

p2 <-  FBFTX %>%
  ggplot(
    aes(x =`Percent Change`, y = factor(day), fill = day)
    )+
  geom_density_ridges(
      stat = "binline", 
      binwidth = 0.0007
    )+
  theme_ridges(
    )+
  paletteer::scale_fill_paletteer_d("PNWColors::Sunset"
    )+
  theme_minimal(
    )+
  labs(
    title = "Comparing Histograms of Percent Change by Day",
    x = "Percent Change",
    y = "Day"
)
  
#Histogram of Log First Difference of Closing Price
p3 <- FBFTX %>%
  ggplot(
    aes(`Log First Difference`) 
  )+
  geom_histogram(
    binwidth = 0.001,
    fill = "#bf7fff"
  )+
  labs(
    title = "Frequency of the Log First Difference",
    x = "Log 1st difference of Closing Price",
    y = "Frequency"
  )+
  theme_minimal(
)
  
  ##Histogram of Percent Change##
p4 <- FBFTX %>%
  ggplot(
  aes(x = `Percent Change`)
  )+ 
  geom_histogram(
    binwidth = 0.0015,
    aes( fill = after_stat(count)),
    show.legend = FALSE
  )+  # Set bin width and transparency
  scale_fill_gradient(
    low = "royalblue", 
    high = "coral"
  )+  # Gradient from low to high counts
  labs(
      title = "Histogram of Percent Change",
      x = "Percent Change",
      y = "Frequency",
      fill = "Count"
  )+  # Label for fill legend
  theme_minimal(
)
  
  
  ##Grouping Percent change by Month and Density at each point##
p5 <- FBFTX %>%
  ggplot(aes('Month', 'Percent Change', color = (`Percent Change`)))+
    geom_count(aes(factor(`month`),`Percent Change`))+
    scale_size(range = c(1,5))+
    scale_x_discrete()+
    paletteer::scale_color_paletteer_c("ggthemes::Sunset-Sunrise Diverging")+
    labs(title = "Percent Change by Month",
         x = "Month",
         y = "Percent Change",
         fill = "Count") +  # Label for fill legend
    theme_minimal()
```
```{r Visualizing Data Cont...}
library(patchwork)
p1
p2
p3
p4
p5
```

```{r Weekly Time Series Analysis}

tseries <- FBFTX$`Closing Price` %>%
  xts(
    order.by = FBFTX$Date
  )

tseries <- tseries %>%
  apply.weekly(FUN = function(x) {(as.numeric(last(x)) - as.numeric(first(x)))/as.numeric(first(x))}
  )

tseries <- tseries %>% coredata()

tseries <- tseries[,1] %>% 
  ts(
    tseries[,1], 
    frequency = 52,
    start = c(2015, 13),
    end = c(2025, 12)
  )
```
```{r Weekly Time Series Viz}
ggAcf(tseries, lag.max = "n")
ggPacf(tseries, lag.max = "n")

plot(tseries)
decomp_series <- tseries %>% decompose(type = "additive")

plot(decomp_series)

ggAcf(decomp_series$trend, lag.max = "n")
ggPacf(decomp_series$trend, lag.max = "n")

```
```{r Weekly Time Series Model}
arima(decomp_series$trend, order = c(6L,0L,6L))
```
